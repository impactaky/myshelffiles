name: Verify setup.sh is built with argc

on:
  push:
    branches: [ "main" ]
  pull_request:
    paths:
      - 'setup.sh'

permissions:
  contents: read

jobs:
  verify-argc-build:
    name: Verify setup.sh is generated by argc
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install argc
        run: |
          # Get the latest release download URL
          ARGC_URL=$(curl -s https://api.github.com/repos/sigoden/argc/releases/latest | grep "browser_download_url.*x86_64-unknown-linux-gnu.tar.gz" | cut -d '"' -f 4)
          wget -q "$ARGC_URL"
          tar -xzf argc-*.tar.gz
          sudo mv argc /usr/local/bin/
          chmod +x /usr/local/bin/argc

      - name: Generate setup.sh with argc and compare
        run: |
          argc --argc-build setup.sh > setup.sh.generated
          if ! cmp -s setup.sh setup.sh.generated; then
            echo "ERROR: setup.sh is not generated by 'argc --argc-build setup.sh'"
            echo "Expected setup.sh to be identical to the result of 'argc --argc-build setup.sh'"
            echo ""
            echo "Differences:"
            diff setup.sh setup.sh.generated || true
            echo ""
            echo "Please run 'argc --argc-build setup.sh > setup.sh' to regenerate the file"
            exit 1
          else
            echo "âœ“ setup.sh is correctly generated by argc --argc-build"
          fi
