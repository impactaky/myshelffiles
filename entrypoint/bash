#!/bin/sh

# Get the absolute path of the script directory
SCRIPT_DIR="$(CDPATH='' cd -- "$(dirname -- "$0")" && pwd)"

# Source the environment setup
. "$SCRIPT_DIR/env.sh"

mkdir -p "$XDG_STATE_HOME"/bash
export HISTFILE="$XDG_STATE_HOME"/bash/history

# Execute bash
if [ ! -e "$SHELFFILES/result" ]; then
    # Check if we have root access but can't modify /nix
    if [ "$(id -u)" -eq 0 ] || [ -w / ]; then
        # Check if /nix exists and is not writable
        if [ -e /nix ] && [ ! -w /nix ]; then
            # Check if namespace is set up
            NAMESPACE_DIR="/run/shelffiles-ns"
            NAMESPACE_NAME="shelffiles_$(echo "$SHELFFILES" | tr '/:' '_')"
            NAMESPACE_PATH="$NAMESPACE_DIR/$NAMESPACE_NAME"
            
            if [ -e "$NAMESPACE_PATH" ]; then
                exec "$SCRIPT_DIR/launch_in_namespace.sh" bash --init-file "$XDG_CONFIG_HOME"/bash/.bashrc "$@"
            else
                echo "Namespace not set up. Please run 'sudo $SCRIPT_DIR/setup_namespace.sh' first."
                exit 1
            fi
        else
            # Use bubblewrap for rootless environment
            exec "$SCRIPT_DIR/launch_in_bwrap.sh" bash --init-file "$XDG_CONFIG_HOME"/bash/.bashrc "$@"
        fi
    else
        # Use bubblewrap for rootless environment
        exec "$SCRIPT_DIR/launch_in_bwrap.sh" bash --init-file "$XDG_CONFIG_HOME"/bash/.bashrc "$@"
    fi
fi
exec bash --init-file "$XDG_CONFIG_HOME"/bash/.bashrc "$@"
