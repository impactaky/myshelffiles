#!/bin/sh

# Get the absolute path of the script directory
SCRIPT_DIR="$(CDPATH='' cd -- "$(dirname -- "$0")" && pwd)"
SHELFFILES="$(CDPATH='' cd -- "$SCRIPT_DIR/.." && pwd)"
export SHELFFILES="$SHELFFILES"

# Source the environment setup
. "$SCRIPT_DIR/env.sh"

# Set ZDOTDIR if not already set
[ -z "$ZDOTDIR" ] && export ZDOTDIR="$XDG_CONFIG_HOME/zsh"

# Workaround for vscode shell integration
export USER_ZDOTDIR="$XDG_CONFIG_HOME/zsh"

# Execute zsh
if [ ! -e "$SHELFFILES/result" ]; then
    # Check if we have root access but can't modify /nix
    if [ "$(id -u)" -eq 0 ] || [ -w / ]; then
        # Check if /nix exists and is not writable
        if [ -e /nix ] && [ ! -w /nix ]; then
            # Check if namespace is set up
            NAMESPACE_DIR="/run/shelffiles-ns"
            NAMESPACE_NAME="shelffiles_$(echo "$SHELFFILES" | tr '/:' '_')"
            NAMESPACE_PATH="$NAMESPACE_DIR/$NAMESPACE_NAME"
            
            if [ -e "$NAMESPACE_PATH" ]; then
                exec "$SCRIPT_DIR/launch_in_namespace.sh" zsh "$@"
            else
                echo "Namespace not set up. Please run 'sudo $SCRIPT_DIR/setup_namespace.sh' first."
                exit 1
            fi
        else
            # Use bubblewrap for rootless environment
            exec "$SCRIPT_DIR/launch_in_bwrap.sh" zsh "$@"
        fi
    else
        # Use bubblewrap for rootless environment
        exec "$SCRIPT_DIR/launch_in_bwrap.sh" zsh "$@"
    fi
fi
exec zsh "$@"
